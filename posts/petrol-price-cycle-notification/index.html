<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us>
<head>
<link href=https://gmpg.org/xfn/11 rel=profile>
<meta charset=utf-8>
<meta name=generator content="Hugo 0.91.2">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Petrol price cycle notifier &#183; jarodl.am</title>
<meta name=description content>
<link type=text/css rel=stylesheet href=https://jarodl.am/css/print.css media=print>
<link type=text/css rel=stylesheet href=https://jarodl.am/css/syntax.css>
<link type=text/css rel=stylesheet href=https://jarodl.am/css/hyde.css>
<link type=text/css rel=stylesheet href=https://jarodl.am/css/overrides.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=/favicon.png>
<meta name=theme-color content="#75b5aa">
</head>
<body class=theme-base-0c>
<aside class=sidebar>
<div class="container sidebar-sticky">
<div class=sidebar-about>
<a href=https://jarodl.am/><h1>jarodl.am</h1></a>
<p class=lead>
Personal projects and more by Jarod Lam.
</p>
</div>
<nav>
<ul class=sidebar-nav>
</ul>
<ul class=sidebar-socials>
<li><a href=https://github.com/jarodlam/><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a>
<li><a href=https://www.linkedin.com/in/jarod-lam/><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
</a>
</ul>
</nav>
</div>
</aside>
<main class="content container">
<div class=post>
<h1>Petrol price cycle notifier</h1>
<time datetime=2021-08-18T12:00:00+1000 class=post-date>Wed, Aug 18, 2021</time>
<img src=/posts/petrol-price-cycle-notification/cover.png>
<p>I used to check the <a href=https://www.accc.gov.au/consumers/petrol-diesel-lpg/petrol-price-cycles>ACCC petrol price cycle web page</a> almost daily as a poor uni student. The moment it seemed like prices were rising, I would rush to the nearest discount petrol station, determined to fit every drop of bargain fuel I could into my petrol tank to tide me over for the next month while prices creeped down.</p>
<p>The web page shows a graph of current average petrol cycles along with a text-based &ldquo;buying tip&rdquo; indicating if prices are <em>increasing</em>, <em>decreasing</em>, at the <em>highest point</em> in the cycle, or the <em>lowest point</em> in the cycle:</p>
<p><img src=accc-website.png alt="ACCC website"></p>
<p>Surely the painless 10-second process of checking this page could be automated, right?</p>
<p>I used <a href=https://script.google.com>Google Apps Script</a>, Google&rsquo;s JavaScript-powered cloud automation tool, to periodically crawl the ACCC price cycle web page and send me an email if the cycle status has changed to &ldquo;increasing&rdquo; or &ldquo;decreasing&rdquo;. I also embedded the fuel price graph in the email. See the cover image for a screenshot.</p>
<p>This script has saved me hundreds of dollars over the years. Even my parents have asked me very nicely to be added to the mailing list :)</p>
<p>Source code is available on <a href=https://github.com/jarodlam/petrol-price-cycle-notification>GitHub</a>.</p>
<h2 id=technical-details>Technical details</h2>
<p>Google Apps Script gives the ability to schedule a JavaScript function that runs on Google&rsquo;s servers at a specified time interval. I&rsquo;ve set my function to run once an hour.</p>
<p>We start by loading the ACCC page and storing the raw HTML source:
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>UrlFetchApp</span>.<span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;https://www.accc.gov.au/consumers/petrol-diesel-lpg/petrol-price-cycles&#34;</span>).<span style=color:#a6e22e>getContentText</span>();</code></pre></div></p>
<p>Then, a regular expression is used to to extract the Brisbane section of the page:
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>regExp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#e6db74>/(Petrol prices in Brisbane&lt;\/h2&gt;)([\S\s]*?)(&lt;\/ul&gt;)/</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>matchedText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>regExp</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>text</span>);</code></pre></div></p>
<p>The matched text is searched for the string <code>"increasing"</code>. We assume that if prices are not increasing, they are decreasing. I only really want to be notified when prices begin to increase so I can buy petrol just before they shoot up.
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>isIncreasing</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>matchedText</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#34;increasing&#34;</span>);</code></pre></div></p>
<p>I also only want to be notified when the state changes, not every time the script runs. We therefore need to be able to check the state from the previous run. To do this, I use Google Apps Script&rsquo;s <code>PropertiesService</code> class, which can store persistent key-value pairs. A property called <code>isIncreasing</code> is set to <code>"increasing"</code> or <code>"decreasing"</code> depending on the current state. The current state is compared to the previous state and terminates execution if they have not changed.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>properties</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>PropertiesService</span>.<span style=color:#a6e22e>getScriptProperties</span>();
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>prevIsIncreasing</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getProperty</span>(<span style=color:#e6db74>&#34;prevIsIncreasing&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>setProperty</span>(<span style=color:#e6db74>&#34;prevIsIncreasing&#34;</span>, <span style=color:#a6e22e>isIncreasing</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isIncreasing</span>.<span style=color:#a6e22e>toString</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>prevIsIncreasing</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>  <span style=color:#a6e22e>Logger</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Current status is the same as previous status (&#34;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>isIncreasing</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;increasing&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;decreasing&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;). Terminating with no notification.&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>  <span style=color:#66d9ef>return</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>}</code></pre></div>
<p>Finally, an email is sent if the state has changed. The Google Apps Script <code>MailApp</code> class provides an interface to send email directly from the currently logged in Gmail account.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#a6e22e>MailApp</span>.<span style=color:#a6e22e>sendEmail</span>({
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>  <span style=color:#a6e22e>bcc</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;example@gmail.com&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>  <span style=color:#a6e22e>subject</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Petrol prices &#34;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>isIncreasing</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;INCREASING!&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;decreasing&#34;</span>),
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>  <span style=color:#a6e22e>htmlBody</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;\
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span style=color:#e6db74>&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;\
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span style=color:#e6db74>&lt;p&gt;This is an automated email.&lt;/p&gt;\
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span style=color:#e6db74>&lt;p&gt;Brisbane petrol prices are now &lt;b&gt;&#34;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>isIncreasing</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;INCREASING&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;DECREASING&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/b&gt;. \
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span style=color:#e6db74>More information &lt;a href=&#39;https://www.accc.gov.au/consumers/petrol-diesel-lpg/petrol-price-cycles#petrol-prices-in-brisbane&#39;&gt;here&lt;/a&gt;.&lt;/p&gt;\
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span style=color:#e6db74>&lt;img src=&#39;https://www.src.gov.au/sites/www.accc.gov.au/files/fuelwatch/brisbane-ulp.png&#39; style=&#39;max-width:100%&#39;&gt;\
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span style=color:#e6db74>&lt;/body&gt;&lt;/html&gt;&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span>});</code></pre></div>
</div>
</main>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R6G6TM3LWM"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-R6G6TM3LWM',{anonymize_ip:!1})}</script>
</body>
</html>